# Nextcloud/Owncloud-specific configuration snippet for Apache
# Usage: IncludeOptional $KAREN_ETC/apache2/snippets/nextcloud-app.conf
# Requires: mod_rewrite, mod_headers

<IfModule mod_rewrite.c>
  RewriteEngine On
  
  # Nextcloud recommended rewrites
  RewriteRule ^\.well-known/carddav /remote.php/dav/ [R=301,L]
  RewriteRule ^\.well-known/caldav /remote.php/dav/ [R=301,L]
  RewriteRule ^remote/(.*) remote.php [QSA,L]
  RewriteRule ^(?:build|tests|config|lib|3rdparty|templates)/.* - [R=404,L]
  RewriteRule ^(?:\.|autotest|occ|issue|indie|db_|console).* - [R=404,L]
</IfModule>

# Security headers for Nextcloud
<IfModule mod_headers.c>
  Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"
  Header always set Referrer-Policy "no-referrer"
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Download-Options "noopen"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set X-Permitted-Cross-Domain-Policies "none"
  Header always set X-Robots-Tag "noindex, nofollow"
  Header always set X-XSS-Protection "1; mode=block"
</IfModule>

# Nextcloud specific file handling
<Files ".htaccess">
  Require all denied
</Files>

<Files "*.log">
  Require all denied
</Files>

<Directory "*/data/*">
  Require all denied
</Directory>

<Directory "*/config/*">
  Require all denied
</Directory>
