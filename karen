#!/bin/bash

# Karen - Server Configuration Management Tool
# Main entry point that sets up environment and delegates to subcommands

# Any allowed alternative would require a full review of the scripts
# We stick to 8.3 for now, the only one we tested, to make sure we do
# not mess up accidentally.
REQUIRES_PHP=8.3
PHPVER=8.3

set -e

# Detect Karen installation directory
SCRIPT_PATH=$(realpath "$0")
KAREN_BASE=$(dirname "$SCRIPT_PATH")
KAREN_DIR="$KAREN_BASE"  # Alias for compatibility
KAREN_ETC="$KAREN_BASE/etc"
KAREN_PRESETS="$KAREN_BASE/presets"
KAREN_TEMPLATES="$KAREN_BASE/templates"
KAREN_BIN="$KAREN_BASE/bin"

# Create/update .env file with Karen paths
create_env_file() {
    echo "$PGM: DEBUG updating $KAREN_BASE/.env" 
    local env_file="$KAREN_BASE/.env"
    
    cat > "$env_file" << EOF
# Karen Configuration Management Tool Environment
# Auto-generated - do not edit manually
# Updated: $(date)

# Base directories
KAREN_BASE="$KAREN_BASE"
KAREN_DIR="$KAREN_BASE"
KAREN_ETC="$KAREN_ETC"
KAREN_PRESETS="$KAREN_PRESETS"
KAREN_TEMPLATES="$KAREN_TEMPLATES"
KAREN_BIN="$KAREN_BIN"

# PHP version (can be overridden)
PHPVER=$PHPVER

# Export all Karen variables
export KAREN_BASE KAREN_DIR KAREN_ETC KAREN_PRESETS KAREN_TEMPLATES KAREN_BIN PHPVER
EOF

    echo "üìù Updated Karen environment: $env_file"
}

# Export environment variables for subcommands
export_karen_env() {
    export KAREN_BASE KAREN_DIR KAREN_ETC KAREN_PRESETS KAREN_TEMPLATES KAREN_BIN
    export PHPVER=${PHPVER}
}

# Display usage information
usage() {
    cat << EOF
Karen - Server Configuration Management Tool

USAGE:
    karen <command> [options...]
    karen --help

COMMANDS:
    apache <dev|prod> [reload|restart]   Switch Apache environment
    caddy <dev|prod> [args...]           Switch Caddy environment  
    php <setup|dev|prod> [args...]       Manage PHP configuration
    env                                   Show current environment
    init                                  Initialize/update .env file
    
EXAMPLES:
    karen apache dev                     Enable Apache development mode
    karen php setup production          Set up PHP in production mode
    karen caddy dev --reload            Switch Caddy to development mode
    karen init                          Create/update .env file
    karen env                           Show Karen environment variables

ENVIRONMENT:
    Karen uses these environment variables (auto-detected):
    KAREN_BASE     = $KAREN_BASE
    KAREN_PRESETS  = $KAREN_PRESETS  
    KAREN_TEMPLATES = $KAREN_TEMPLATES
    KAREN_ETC      = $KAREN_ETC

For more help on specific commands, run: karen <command> --help
EOF
}

# Show current environment
show_env() {
    echo "Karen Environment:"
    echo "  KAREN_BASE      = $KAREN_BASE"
    echo "  KAREN_DIR       = $KAREN_DIR" 
    echo "  KAREN_PRESETS   = $KAREN_PRESETS"
    echo "  KAREN_TEMPLATES = $KAREN_TEMPLATES"
    echo "  KAREN_ETC       = $KAREN_ETC"
    echo "  KAREN_BIN       = $KAREN_BIN"
    echo "  PHPVER          = ${PHPVER:-8.3}"
    echo ""
    echo ".env file: $KAREN_BASE/.env"
    if [ -f "$KAREN_BASE/.env" ]; then
        echo "  Status: ‚úÖ exists (updated: $(stat -c %y "$KAREN_BASE/.env" | cut -d' ' -f1))"
    else
        echo "  Status: ‚ùå missing (run 'karen init' to create)"
    fi
}

# Main command dispatcher
main() {
    # Always create/update .env file on startup
    create_env_file
    
    # Export environment for subcommands
    export_karen_env
    
    # Parse command
    case "${1:-}" in
        ""|"--help"|"-h"|"help")
            usage
            ;;
        "env"|"environment")
            show_env
            ;;
        "init"|"setup")
            create_env_file
            show_env
            ;;
        "apache"|"a2")
            shift
            exec "$KAREN_BIN/a2toggle" "$@"
            ;;
        "caddy"|"c2")
            case "${2:-}" in
                "dev"|"development")
                    shift 2
                    exec "$KAREN_BIN/c2endev" "$@"
                    ;;
                "prod"|"production") 
                    shift 2
                    exec "$KAREN_BIN/c2enprod" "$@"
                    ;;
                *)
                    echo "Usage: karen caddy <dev|prod> [args...]"
                    exit 1
                    ;;
            esac
            ;;
        "php")
            case "${2:-}" in
                "setup")
                    shift 2
                    exec "$KAREN_BIN/setup-php" "$@"
                    ;;
                "dev"|"development")
                    shift 2
                    exec "$KAREN_BIN/setup-php" development "$@"
                    ;;
                "prod"|"production")
                    shift 2  
                    exec "$KAREN_BIN/setup-php" production "$@"
                    ;;
                *)
                    echo "Usage: karen php <setup|dev|prod> [args...]"
                    exit 1
                    ;;
            esac
            ;;
        *)
            echo "Unknown command: $1"
            echo "Run 'karen --help' for usage information."
            exit 1
            ;;
    esac
}

main "$@"
