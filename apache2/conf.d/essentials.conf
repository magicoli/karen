# Global Apache Configuration - Always Active
# This file contains security-critical settings that must never be disabled
# Located in conf.d/ - automatically loaded and cannot be disabled via a2enmod

# SECURITY: Default PHP processing - MUST always be active
# This prevents PHP source code exposure if pseudo-modules are disabled
<IfModule mod_proxy_fcgi.c>
  # Default PHP handler - prevents PHP source code exposure
  <FilesMatch "\.php$">
    SetHandler "proxy:unix:/run/php/php8.3-fpm.sock|fcgi://localhost"
  </FilesMatch>
</IfModule>


# SECURITY: Global directory protection - secure by default
# This applies to ALL directories unless overridden by specific site configs
<Directory />
    Options -Indexes -FollowSymLinks
    AllowOverride None
    Require all denied
</Directory>

# Allow basic access to web directories (still with security)
<Directory "/var/www">
    Options -Indexes -FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

# Specifically secure the default document root  
<Directory "/var/www/html">
    Options -Indexes -FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

# Exception: Allow Let's Encrypt challenges
<Directory "/var/www/letsencrypt/.well-known/acme-challenge/">
    Options None
    AllowOverride None
    Require all granted
</Directory>
# SECURITY: Global security headers
<IfModule mod_headers.c>
    # Remove sensitive server information
    Header always unset Server
    Header always unset X-Powered-By
    
    # Basic security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
</IfModule>

# Default directory index priority
DirectoryIndex index.php index.html index.htm

# Common aliases and redirects
Alias /.well-known/acme-challenge/ /var/www/letsencrypt/.well-known/acme-challenge/
<Directory "/var/www/letsencrypt/.well-known/acme-challenge/">
    Options None
    AllowOverride None
    Require all granted
</Directory>

# Prevent access to sensitive files
<FilesMatch "^(wp-config\.php|\.htaccess|\.env|composer\.(json|lock)|package\.json)$">
    Require all denied
</FilesMatch>
