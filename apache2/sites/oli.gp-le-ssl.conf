<IfModule mod_ssl.c>
<VirtualHost *:443>
  <ifmodule mpm_itk_module>
    AssignUserID magic magic
  </ifmodule>
  <ifmodule suexec_module>
    SuexecUserGroup magic magic
  </ifmodule>
  ServerName oli.gp
  ServerAlias www.oli.gp
  ServerAlias oli.pm
  ServerAlias www.oli.pm
  ServerAlias oli.re
  ServerAlias www.oli.re
  ServerAlias mgc.re
  ServerAlias www.mgc.re

  DocumentRoot /home/magic/domains/oli.gp/www
  ErrorLog /var/log/apache2/oli.gp.error.log
  CustomLog /var/log/apache2/oli.gp.access.log combined

# DirectoryIndex index.html index.htm index.php /lib/wrap/wrap.php

  <Directory /home/magic/domains/oli.gp/www>
    <IfVersion < 2.3>
      Order allow,deny
      Allow from all
    </IfVersion>
    <IfVersion >= 2.3>
      Require all granted
    </IfVersion>
    Options -Indexes +Includes +IncludesNOEXEC +SymLinksIfOwnerMatch
    AllowOverride All
  </Directory>

  <Directory /home/magic/domains/oli.gp/tmp/www/www>
    AllowOverride All
  </Directory>

  php_admin_value open_basedir "/opt/magic/lib:/usr/share:/var/lib:/var/tmp:/home/magic/domains/oli.gp:."
  php_admin_value upload_tmp_dir "/home/magic/domains/oli.gp/tmp/www/www"
  php_admin_value session.save_path "/home/magic/domains/oli.gp/tmp/www/www"
  php_value memory_limit 256M
  php_value max_input_vars 2000
  php_value max_execution_time 60
  # php_value upload_max_filesize "100M"
  # php_value post_max_size "100M"
  # php_value sendmail_path "/usr/sbin/sendmail -t -i -f webmaster@oli.gp"

  # RewriteEngine on
  # RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]

  SSLEngine on
  
    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}
    AllowEncodedSlashes NoDecode
    ProxyPreserveHost on
    ProxyPass /_matrix http://127.0.0.1:8008/_matrix nocanon
    ProxyPassReverse /_matrix http://127.0.0.1:8008/_matrix
    ProxyPass /_synapse/client http://127.0.0.1:8008/_synapse/client nocanon
    ProxyPassReverse /_synapse/client http://127.0.0.1:8008/_synapse/client

#RewriteEngine on
# Some rewrite rules in this file were disabled on your HTTPS site,
# because they have the potential to create redirection loops.

# RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]

Include /etc/letsencrypt/options-ssl-apache.conf
SSLCertificateFile /etc/letsencrypt/live/oli.gp/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/oli.gp/privkey.pem
</VirtualHost>
</IfModule>
